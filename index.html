<!DOCTYPE html>
<html>
<head>
    <link rel="manifest" href="manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro Doodle Studio</title>

<style>
:root{
    --bg:#222;
    --panel:#333;
    --text:white;
}

body{
    margin:0;
    font-family:sans-serif;
    background:var(--bg);
    color:var(--text);
    display:flex;
    flex-direction:column;
    align-items:center;
    transition:0.3s;
}

.light{
    --bg:#f4f4f4;
    --panel:white;
    --text:black;
}

.controls{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    padding:10px;
    background:var(--panel);
    width:100%;
    justify-content:center;
}

canvas{
    background:white;
    touch-action:none;
    cursor:crosshair;
}

button,select,input{
    cursor:pointer;
}
</style>
</head>
<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
<body>

<div class="controls">
Stroke <input type="color" id="color" value="#000000">
Width <input type="range" id="width" min="1" max="50" value="5">
BG <input type="color" id="bgColor" value="#ffffff">

<select id="brushType">
<option value="normal">Normal</option>
<option value="glow">Glow</option>
<option value="spray">Spray</option>
</select>

<button id="eraser">Eraser</button>
<button id="colorPicker">Pick Color</button>
<button id="themeToggle">Toggle Theme</button>

<button id="undo">Undo</button>
<button id="redo">Redo</button>
<button id="clear">Clear</button>
<button id="save">Save PNG</button>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

function resizeCanvas(){
    canvas.width=window.innerWidth;
    canvas.height=window.innerHeight-document.querySelector(".controls").offsetHeight;
}
resizeCanvas();
window.addEventListener("resize",resizeCanvas);

let drawing=false;
let history=[];
let redoStack=[];
let pickingColor=false;

function saveState(){
    history.push(canvas.toDataURL());
    redoStack=[];
}

function restoreState(from,to){
    if(from.length){
        to.push(canvas.toDataURL());
        let img=new Image();
        img.src=from.pop();
        img.onload=()=>ctx.drawImage(img,0,0);
    }
}

canvas.addEventListener("mousedown",startDraw);
canvas.addEventListener("mousemove",draw);
canvas.addEventListener("mouseup",endDraw);

canvas.addEventListener("touchstart",e=>{
    e.preventDefault();
    startDraw(e.touches[0]);
});
canvas.addEventListener("touchmove",e=>{
    e.preventDefault();
    draw(e.touches[0]);
});
canvas.addEventListener("touchend",endDraw);

function startDraw(e){
    let rect=canvas.getBoundingClientRect();
    let x=e.clientX-rect.left;
    let y=e.clientY-rect.top;

    if(pickingColor){
        let pixel=ctx.getImageData(x,y,1,1).data;
        let rgb=`rgb(${pixel[0]},${pixel[1]},${pixel[2]})`;
        document.getElementById("color").value=rgbToHex(pixel[0],pixel[1],pixel[2]);
        pickingColor=false;
        return;
    }

    drawing=true;
    ctx.beginPath();
    ctx.moveTo(x,y);
    saveState();
}

function draw(e){
    if(!drawing) return;

    let rect=canvas.getBoundingClientRect();
    let x=e.clientX-rect.left;
    let y=e.clientY-rect.top;

    ctx.lineWidth=document.getElementById("width").value;
    ctx.strokeStyle=document.getElementById("color").value;
    ctx.lineCap="round";

    let brush=document.getElementById("brushType").value;

    if(brush==="glow"){
        ctx.shadowBlur=20;
        ctx.shadowColor=ctx.strokeStyle;
    } else {
        ctx.shadowBlur=0;
    }

    if(brush==="spray"){
        for(let i=0;i<10;i++){
            ctx.fillStyle=ctx.strokeStyle;
            ctx.fillRect(x+Math.random()*20-10,y+Math.random()*20-10,1,1);
        }
    } else {
        ctx.lineTo(x,y);
        ctx.stroke();
    }
}

function endDraw(){
    drawing=false;
    ctx.beginPath();
}

// RGB to HEX converter
function rgbToHex(r,g,b){
    return "#" + [r,g,b].map(x=>{
        const hex=x.toString(16);
        return hex.length===1?"0"+hex:hex;
    }).join("");
}

// Color Picker
document.getElementById("colorPicker").onclick=()=>{
    pickingColor=true;
    alert("Click on canvas to pick color");
};

// Theme Toggle
document.getElementById("themeToggle").onclick=()=>{
    document.body.classList.toggle("light");
};

// Background
document.getElementById("bgColor").addEventListener("input",e=>{
    canvas.style.backgroundColor=e.target.value;
});

// Undo Redo
document.getElementById("undo").onclick=()=>restoreState(history,redoStack);
document.getElementById("redo").onclick=()=>restoreState(redoStack,history);

// Clear
document.getElementById("clear").onclick=()=>{
    saveState();
    ctx.clearRect(0,0,canvas.width,canvas.height);
};

// Save
document.getElementById("save").onclick=()=>{
    let link=document.createElement("a");
    link.download="doodle.png";
    link.href=canvas.toDataURL();
    link.click();
};
</script>

</body>
  </html>
